"""–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
from aiogram import Router, F, Bot
from aiogram.types import Message

from bot.config import config
from bot.database import get_db_session
from bot.repositories.user_repository import UserRepository
from bot.services.openrouter import openrouter_service
from bot.keyboards import get_share_keyboard, get_main_menu_keyboard
from bot.logger import logger

router = Router()


@router.message(F.photo)
async def process_photo(message: Message, bot: Bot):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    telegram_id = message.from_user.id
    photo = message.photo[-1]  # –ë–µ—Ä–µ–º —Ñ–æ—Ç–æ –Ω–∞–∏–±–æ–ª—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞

    logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {telegram_id}")

    async with get_db_session() as session:
        user_repo = UserRepository(session)

        # –ê—Ç–æ–º–∞—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –∏ —Å–ø–∏—Å—ã–≤–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
        # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
        spent, new_balance = await user_repo.try_spend_generation(telegram_id)

        if not spent:
            # –ù–µ —É–¥–∞–ª–æ—Å—å —Å–ø–∏—Å–∞—Ç—å - –ª–∏–±–æ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ª–∏–±–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
            if new_balance is None:
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
                await message.answer(
                    "‚ö†Ô∏è <b>–£–ø—Å! –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫</b>\n\n"
                    "–ü–æ—Ö–æ–∂–µ, —Ç—ã –µ—â—ë –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –±–æ—Ç–µ.\n\n"
                    "üéÑ –ù–∞–∂–º–∏ /start —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º –∏ –ø–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏!"
                )
                logger.error(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: {telegram_id}")
            else:
                # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π (new_balance —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 0 –∏–ª–∏ –±–æ–ª—å—à–µ)
                await message.answer(
                    "üòî <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!</b>\n\n"
                    f"üíé –ù–∞ —Ç–≤–æ—ë–º –±–∞–ª–∞–Ω—Å–µ: <b>{new_balance} –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</b>\n\n"
                    "–ù–æ –Ω–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è! –¢—ã –º–æ–∂–µ—à—å:\n\n"
                    "üí≥ <b>–ö—É–ø–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</b>\n"
                    "–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é –∏ –≤—ã–±–µ—Ä–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∞—Ä–∏—Ñ\n\n"
                    "ü§ù <b>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</b>\n"
                    "–ü–æ–ª—É—á–∏ –±–æ–Ω—É—Å–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞!\n\n"
                    "‚ú® –ò—Å–ø–æ–ª—å–∑—É–π –º–µ–Ω—é –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å üëá"
                )
                logger.info(f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {telegram_id}")
            return

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        processing_message = await message.answer(
            "‚ú® <b>–ù–∞—á–∏–Ω–∞–µ–º –≤–æ–ª—à–µ–±—Å—Ç–≤–æ!</b>\n\n"
            "üé® –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º —Ç–≤–æ—ë —Ñ–æ—Ç–æ –≤ –≤–∏–Ω—Ç–∞–∂–Ω—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –≤ —Å—Ç–∏–ª–µ 90—Ö...\n"
            "üé¨ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥\n\n"
            "‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ..."
        )

        logger.info(f"–ù–∞—á–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è {telegram_id}")

        try:
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ OpenRouter
            generated_image = await openrouter_service.process_user_image(bot, photo)

            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            await processing_message.delete()

            if generated_image:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"
                # share_keyboard = get_share_keyboard(config.bot.bot_username)

                await message.answer_photo(
                    photo=generated_image,
                    caption=config.bot.image_caption,
                    # reply_markup=share_keyboard
                )

                logger.info(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {telegram_id}")

                # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω—é
                user = await user_repo.get_user_by_telegram_id(telegram_id)

                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å (new_balance —É–∂–µ –ø–æ–ª—É—á–µ–Ω –∏–∑ try_spend_generation)
                balance_emoji = "üéâ" if new_balance > 0 else "üòä"

                balance_info = (
                    f"{balance_emoji} <b>–†–µ—Ç—Ä–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –≥–æ—Ç–æ–≤–∞!</b>\n\n"
                    f"üíé –û—Å—Ç–∞–ª–æ—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–π: <b>{new_balance}</b>\n\n"
                )

                if new_balance == 0:
                    balance_info += (
                        "üì∏ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å, –Ω–æ —Ç—ã –º–æ–∂–µ—à—å:\n"
                        "üí≥ –ö—É–ø–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ –º–µ–Ω—é\n"
                        "ü§ù –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å—ã"
                    )
                else:
                    balance_info += (
                        "üì∏ –û—Ç–ø—Ä–∞–≤—å –µ—â—ë —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–µ—Ç—Ä–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é!"
                    )

                await message.answer(
                    balance_info,
                    reply_markup=get_main_menu_keyboard(is_admin=user.is_admin if user else False)
                )

            else:
                # –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
                await user_repo.update_generations(telegram_id, +1)

                # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω—é
                user = await user_repo.get_user_by_telegram_id(telegram_id)

                await message.answer(
                    "üòû <b>–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ—Ç—Ä–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</b>\n\n"
                    "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n\n"
                    "‚úÖ <b>–•–æ—Ä–æ—à–∞—è –Ω–æ–≤–æ—Å—Ç—å:</b> –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –Ω–∞ —Ç–≤–æ–π –±–∞–ª–∞–Ω—Å!\n\n"
                    "üîÑ –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é.\n\n"
                    "üí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:</b>\n"
                    "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —á—ë—Ç–∫–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å —Ö–æ—Ä–æ—à–∏–º –æ—Å–≤–µ—â–µ–Ω–∏–µ–º\n"
                    "‚Ä¢ –õ–∏—Ü–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ö–æ—Ä–æ—à–æ –≤–∏–¥–Ω—ã\n"
                    "‚Ä¢ –ò–∑–±–µ–≥–∞–π —Å–ª–∏—à–∫–æ–º —Ç—ë–º–Ω—ã—Ö –∏–ª–∏ —Ä–∞–∑–º—ã—Ç—ã—Ö —Å–Ω–∏–º–∫–æ–≤",
                    reply_markup=get_main_menu_keyboard(is_admin=user.is_admin if user else False)
                )

                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è {telegram_id}")

        except Exception as e:
            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            try:
                await processing_message.delete()
            except:
                pass

            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
            await user_repo.update_generations(telegram_id, +1)

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω—é
            user = await user_repo.get_user_by_telegram_id(telegram_id)

            await message.answer(
                "‚ö†Ô∏è <b>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞</b>\n\n"
                "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–≤–æ—ë —Ñ–æ—Ç–æ –∏–∑-–∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏.\n\n"
                "‚úÖ <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –Ω–∞ —Ç–≤–æ–π –±–∞–ª–∞–Ω—Å!</b>\n\n"
                "üîÑ –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.\n\n"
                "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É üí¨",
                reply_markup=get_main_menu_keyboard(is_admin=user.is_admin if user else False)
            )

            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}", exc_info=True)
